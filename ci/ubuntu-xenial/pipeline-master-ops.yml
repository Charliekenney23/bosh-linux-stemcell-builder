- type: replace
  path: /resources/-
  value:
    name: slack-alert
    type: slack-notification
    source:
      url: ((slack_hook_url))

- type: replace
  path: /resource_types/-
  value:
    name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest

- type: replace
  path: /groups/name=master/jobs/-
  value: notify-of-usn

- type: replace
  path: /jobs/-
  value:
    name: notify-of-usn
    plan:
      - get: xenial-usn
        trigger: true
      - task: build-slack-message
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: bosh/main
          inputs: [{ name: xenial-usn }]
          outputs: [{ name: slack-message }]
          run:
            path: /bin/bash
            args:
            - -c
            - |
              set -exu -o pipefail
              cat <<EOF > template.json
              {
                "attachments": {
                  "color": "#ff0000",
                    "thumb_url": "http://www.free-icons-download.net/images/lock-icon-66412.png",
                    "footer": "USN Notification",
                    "footer_icon": "https://i.imgur.com/7H8ZIq1.png",
                    "mrkdwn_in": ["fields"],
                    "fields": [
                    {"title": "Priorities", "short": true, "value": (.priorities | join(", "))},
                    {"title": "Date", "short": true, "value": .date},
                    {"title": "Description", "short": false, "value": .description},
                    {"title": "CVEs", "short": false, "value": (.cves | join("\n"))}
                    ]
                }
              }
              EOF
              cat xenial-usn/usn.json | jq -r "$(cat template.json)" | tee slack-message/attachments
              cat xenial-usn/usn.json | jq -r '"New USN for Xenial: *<\(.url)|\(.title)>*"' | tee slack-message/message
      - put: slack-alert
        params:
          channel: ((usn_notifications_slack_channel_name))
          icon_url: https://i.imgur.com/A0Vlw5t.png
          attachments_file: slack-message/attachments
          text_file: slack-message/message

- type: replace
  path: /groups/name=master/jobs/-
  value: deploy-acceptance-env

- type: replace
  path: /jobs/-
  value:
    name: deploy-acceptance-env
    serial: true
    plan:
      - aggregate:
        - get: bbl-state
          resource: acceptance-env-state
        - get: zookeeper-release
        - get: version
          resource: version-master
          passed:
          - build-warden-boshlite-master
          - build-aws-xen-hvm-master
          - build-azure-hyperv-master
          - build-google-kvm-master
          - build-openstack-kvm-master
          - build-vsphere-esxi-master
          - build-vcloud-esxi-master
          trigger: true
        - get: bosh-deployment
        - get: stemcell
          resource: google-kvm-master
          trigger: true
          passed:
          - build-google-kvm-master
      - task: deploy-env
        file: bosh-src/ci/tasks/setup-env.yml
        params:
          BBL_GCP_SERVICE_ACCOUNT_KEY: ((acceptance_gcp_service_account_key))
          BBL_GCP_REGION: us-west2
          BBL_IAAS: gcp
        ensure:
          put: acceptance-env-state
          params:
            repository: updated-bbl-state
            rebase: true

- type: replace
  path: /resources/-
  value:
    name: acceptance-env-state
    type: git
    source:
      branch: master
      uri: git@github.com:cloudfoundry/bosh-bbl-ci-envs.git
      private_key: ((bosh-bbl-ci-envs-private-key))

- type: replace
  path: /resources/-
  value:
    name: zookeeper-release
    type: git
    source:
      uri: https://github.com/cppforlife/zookeeper-release
      branch: master

